version: "3.9"

x-airflow-common: &airflow-common
  image: apache/airflow:2.9.3-python3.11
  env_file:
    - /opt/airflow/airflow.env
  environment:
    AIRFLOW__CORE__LOAD_EXAMPLES: "False"
    AIRFLOW__CORE__EXECUTOR: SequentialExecutor
    AIRFLOW__WEBSERVER__WEB_SERVER_HOST: 0.0.0.0
    AIRFLOW__WEBSERVER__WEB_SERVER_PORT: "8080"
    # Optionally install AWS provider at startup; if flaky, remove and install inside container
    _PIP_ADDITIONAL_REQUIREMENTS: apache-airflow-providers-amazon
  volumes:
    - /opt/airflow/repo/airflow/dags:/opt/airflow/dags
    - airflow_home:/opt/airflow

services:
  airflow-init:
    <<: *airflow-common
    restart: "no"
    command: bash -c "airflow db migrate && airflow users create --username airflow --password airflow --firstname Admin --lastname User --role Admin --email admin@example.com || true"

  airflow-webserver:
    <<: *airflow-common
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    restart: unless-stopped
    ports:
      - "8080:8080"
    command: airflow webserver

  airflow-scheduler:
    <<: *airflow-common
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    restart: unless-stopped
    command: airflow scheduler

volumes:
  airflow_home:
